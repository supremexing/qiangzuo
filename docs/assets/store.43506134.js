import{L as e,af as t,al as s,x as n,am as a,y as o,U as i,a7 as r,ag as u,an as l,W as c,ao as d,T as g,a6 as f,V as p}from"./index-8c7aba04.js";const h=e.importObject("uni-id-co"),I=e.database().collection("libraux-users");let _=t("uni-id-pages-userInfo")||{};const v={async updateUserInfo(e=!1){if(e)I.where("_id==$cloudEnv_uid").update(e).then((t=>{t.result.updated?(n({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(e)):n({title:"没有改变",icon:"none",duration:3e3})}));else try{let e=await I.where("_id==$cloudEnv_uid").field("mobile,nickname,avatar,vip_date").get();this.setUserInfo({...e.result.data[0]})}catch(t){this.setUserInfo({},{cover:!0}),console.error(t.message,t.errCode)}},async setUserInfo(e,{cover:t}={cover:!1}){let s=t?e:Object.assign(U.userInfo,e),n=new Date(s.vip_date);return s.vip_date?s.vip_date_str=`${n.getFullYear()}/${n.getMonth()+1}/${n.getDate()}`:s.vip_date_str="前往充值",U.userInfo=Object.assign({},s),U.hasLogin=0!=Object.keys(U.userInfo).length,a("uni-id-pages-userInfo",U.userInfo),e},async loginSuccess(e={}){const{showToast:t=!0,toastText:s="登录成功",autoBack:a=!0,uniIdRedirectUrl:u=""}=e;t&&n({title:s,icon:"none",duration:1500});const l=o();await l.AppOnLaunch(),this.updateUserInfo(),i("uni-id-pages-login-success"),r({url:"/pages/home/index"})},async logout(){if(e.getCurrentUserInfo().tokenExpired>Date.now())try{await h.logout()}catch(t){console.error(t)}u("uni_id_token");for(let e in l)u(l[e]);a("uni_id_token_expired",0),c({url:`/${d.uniIdRouter&&d.uniIdRouter.loginPage?d.uniIdRouter.loginPage:"pages/login/login"}`}),i("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(e={}){const{uniIdRedirectUrl:t=""}=e;let s=0,n=g();if(n.forEach(((e,t)=>{"login"==n[n.length-t-1].route.split("/")[3]&&s++})),t)return c({url:t,fail:e=>{f({url:t,fail:t=>{console.log(e,t)}})}});if(s){const e=d.pages[0];return r({url:`/${e.path}`})}p({delta:s})}},U=s({userInfo:_,hasLogin:0!=Object.keys(_).length});export{v as m,U as s};
